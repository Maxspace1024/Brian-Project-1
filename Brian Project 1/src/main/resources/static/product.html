<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/product.css">
    <script src="js/config.js"></script>
    <script src="js/product.js"></script>
    <title>STYLiSH</title>
    <style>
        .jumbotron {
            text-align: center;
        }
        .text-left {
            text-align: left;
        }
        .container {
            max-width: 750px;
        }
        form {
            padding: 40px;
            box-shadow: 0 7px 14px rgba(50, 50, 93, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
        }
        .tappay-field-focus {
            border-color: #66afe9;
            outline: 0;
            -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075), 0 0 8px rgba(102, 175, 233, .6);
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075), 0 0 8px rgba(102, 175, 233, .6);
        }
        .has-error .tappay-field-focus {
            border-color: #843534;
            -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075), 0 0 6px #ce8483;
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075), 0 0 6px #ce8483;
        }
        .has-success .tappay-field-focus {
            border-color: #2b542c;
            -webkit-box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075), 0 0 6px #67b168;
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075), 0 0 6px #67b168;
        }
    </style>

</head>
<body>
<header>
    <nav class="topnav">
        <div class="nav-left">
            <a href="/index.html"><img src="assets/images/logo.png" alt="logo" height="40px"></a>
            <ul>
                <li><a href="/index.html?category=women">女裝</a></li>
                <li><a href="/index.html?category=men">男裝</a></li>
                <li><a href="/index.html?category=accessories">配件</a></li>
            </ul>
        </div>
        <div class="item">
            <div class="input-container">
                <input type="text" placeholder="Enter text here">
                <div style="display: inline-block;">
                    <img id="btnsearch" class="imgbtn" src="assets/images/search.png" alt="logo" height="40px">
                </div>
            </div>
            <div class="item">
                <img id="btncart" class="imgbtn" src="assets/images/cart.png" alt="logo" height="40px">
            </div>
            <div class="item">
                <a href="profile.html"><img id="btnmember" class="imgbtn" src="assets/images/member.png" alt="logo" height="40px"></a>
            </div>
        </div>
    </nav>
    <div class="blackline"></div>
</header>
<main>
    <div class="product-detail">
        <div class="product-container">
            <div class="product-image">
                <img id="imgmain" alt="main_image">
            </div>
            <div class="product-details">
                <h1 id="product-title" style="margin-bottom: 0;"></h1>
                <span id="product-id" style="color: #aaa;"></span>
                <br>
                <br>
                <p id="product-price" style="font-size: 2rem; font-weight: bolder;"></p>

                <hr>
                <div class="color-options">
                    顏色：
                </div>

                <div class="size-options">
                    尺寸：
                </div>

                <div class="quantity">
                    數量：
                    <div class="number-input">
                        <button id="btndec">-</button>
                        <input type="number" id="order-qty" value="1">
                        <button id="btninc">+</button>
                    </div>
                </div>

                <button class="button-order">結帳</button>

                <span>&nbsp;</span><br>
                <span>實品顏色依單品照為主</span><br><br>

                <span id="product-texture">材質:</span><br>
                <span>厚薄：薄</span><br>
                <span>彈性：無</span><br><br>

                <span id="product-wash">清洗：</span><br>
                <span id="product-place">產地：</span><br><br>
            </div>
        </div>
        <div style="display: flex;">
            <span style="flex: 1; color: rgb(214, 155, 18); font-weight: bolder;">更多產品資訊</span>
            <hr style="flex: 5; border-bottom: transparent; border-left: transparent; border-right: transparent;">
        </div>
        <div>
            <p id="product-story">storystorystorystorystorystory</p>
            <div id="img-contents"></div>
        </div>
        <hr>
        <hr>
        <div id="payment" class="container" style="display: none;">
            <div class="row">
                <div class="col-md-6">
                    <h2>交易明細</h2>
                    <div class="receipt-row">
                        <span>消費金額</span>
                        <span id="textPrice">0</span>
                    </div>
                    <div class="receipt-row">
                        <span>運費</span>
                        <span id="textFee">0</span>
                    </div>
                    <hr>
                    <div class="receipt-row">
                        <span>總金額</span>
                        <span id="textTotalPrice" style="font-size: 1.5rem; font-weight: bolder;">0</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <h2>支付資訊</h2>
                    <form>
                        <div class="form-group card-number-group">
                            <label for="card-number" class="control-label"><span id="cardtype"></span>卡號</label>
                            <div class="form-control card-number"></div>
                        </div>
                        <div class="form-group expiration-date-group">
                            <label for="expiration-date" class="control-label">卡片到期日</label>
                            <div class="form-control expiration-date" id="tappay-expiration-date"></div>
                        </div>
                        <div class="form-group ccv-group">
                            <label for="ccv" class="control-label">卡片後三碼</label>
                            <div class="form-control ccv"></div>
                        </div>

                        <button type="submit" class="btn btn-default">Pay</button>
                    </form>
                </div>
            </div>
        
        </div>
    </div>
</main>
<footer>
    <nav class="footernav">
        <div class="item">
            <ul>
                <li><a href="#">關於 STYLiSH</a></li>
                <li><a href="#">服務條款</a></li>
                <li><a href="#">隱私政策</a></li>
                <li><a href="#">聯絡我們</a></li>
                <li><a href="#">FAQ</a></li>
            </ul>
        </div>
        <div class="item">
            <img id="btnline" class="imgbtn" src="/assets/images/line.png" alt="line">
        </div>
        <div class="item">
            <img id="btntwitter" class="imgbtn" src="/assets/images/twitter.png" alt="twitter">
        </div>
        <div class="item">
            <img id="btnfacebook" class="imgbtn" src="/assets/images/facebook.png" alt="facebook">
        </div>
        <div class="item">
            <span style="color: white;">&copy; 2024 All right reserved.</span>
        </div>
    </nav>
</footer>

<script src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
<script src="https://js.tappaysdk.com/sdk/tpdirect/v5.18.0"></script>
<script>
    TPDirect.setupSDK(152585, 'app_zab7HUi81lRsnhVKXgXVAQlPB6GrEDr3JJwJY1eqMBIb0J14iaf0heqdikih', 'sandbox')
    TPDirect.card.setup({
        fields: {
            number: {
                element: '.form-control.card-number',
                placeholder: '**** **** **** ****'
            },
            expirationDate: {
                element: document.getElementById('tappay-expiration-date'),
                placeholder: 'MM / YY'
            },
            ccv: {
                element: $('.form-control.ccv')[0],
                placeholder: '後三碼'
            }
        },
        styles: {
            'input': {
                'color': 'gray'
            },
            'input.ccv': {
                // 'font-size': '16px'
            },
            ':focus': {
                'color': 'black'
            },
            '.valid': {
                'color': 'green'
            },
            '.invalid': {
                'color': 'red'
            },
            '@media screen and (max-width: 400px)': {
                'input': {
                    'color': 'orange'
                }
            }
        },
        // 此設定會顯示卡號輸入正確後，會顯示前六後四碼信用卡卡號
        isMaskCreditCardNumber: true,
        maskCreditCardNumberRange: {
            beginIndex: 6,
            endIndex: 11
        }
    })
    // listen for TapPay Field
    TPDirect.card.onUpdate(function (update) {
        /* Disable / enable submit button depend on update.canGetPrime  */
        /* ============================================================ */

        // update.canGetPrime === true
        //     --> you can call TPDirect.card.getPrime()
        // const submitButton = document.querySelector('button[type="submit"]')
        if (update.canGetPrime) {
            // submitButton.removeAttribute('disabled')
            $('button[type="submit"]').removeAttr('disabled')
        } else {
            // submitButton.setAttribute('disabled', true)
            $('button[type="submit"]').attr('disabled', true)
        }


        /* Change card type display when card type change */
        /* ============================================== */

        // cardTypes = ['visa', 'mastercard', ...]
        var newType = update.cardType === 'unknown' ? '' : update.cardType
        $('#cardtype').text(newType)



        /* Change form-group style when tappay field status change */
        /* ======================================================= */

        // number 欄位是錯誤的
        if (update.status.number === 2) {
            setNumberFormGroupToError('.card-number-group')
        } else if (update.status.number === 0) {
            setNumberFormGroupToSuccess('.card-number-group')
        } else {
            setNumberFormGroupToNormal('.card-number-group')
        }

        if (update.status.expiry === 2) {
            setNumberFormGroupToError('.expiration-date-group')
        } else if (update.status.expiry === 0) {
            setNumberFormGroupToSuccess('.expiration-date-group')
        } else {
            setNumberFormGroupToNormal('.expiration-date-group')
        }

        if (update.status.ccv === 2) {
            setNumberFormGroupToError('.ccv-group')
        } else if (update.status.ccv === 0) {
            setNumberFormGroupToSuccess('.ccv-group')
        } else {
            setNumberFormGroupToNormal('.ccv-group')
        }
    })

    $('form').on('submit', function (event) {
        event.preventDefault()
        // check token
        let token = localStorage.getItem("token")
        if (token == null) {
            location.href = "profile.html"
        } else {
            fetch(`http://${HOST}:${PORT}/api/1.0/user/profile`, {
                method: "GET",
                headers: {
                    "Authorization": `Bearer ${token}`
                }
            })
            .then(r => r.json())
            .then(d => {
                if ("error" in d) {
                    location.href = "profile.html"
                }
            })
            .catch(e => {console.log(e)})
        }

        // fix keyboard issue in iOS device
        forceBlurIos()

        const tappayStatus = TPDirect.card.getTappayFieldsStatus()
        // console.log(tappayStatus)

        // Check TPDirect.card.getTappayFieldsStatus().canGetPrime before TPDirect.card.getPrime
        if (tappayStatus.canGetPrime === false) {
            alert('can not get prime')
            return
        }

        // Get prime
        TPDirect.card.getPrime(function (result) {
            if (result.status !== 0) {
                alert('get prime error ' + result.msg)
                return
            }

            let orderRequest = {
                "prime": result.card.prime,
                "order": {
                    "shipping": "delivery",
                    "payment": "credit_card",
                    "subtotal": orderData.price,
                    "freight": orderData.fee,
                    "total": orderData.total_price,
                    "recipient": {
                        "name": "Luke",
                        "phone": "0987654321",
                        "email": "luke@gmail.com",
                        "address": "市政府站",
                        "time": "morning"
                    },
                    "list": [
                        {
                            "id": orderData.product_id,
                            "name": orderData.product_name,
                            "price": orderData.unit_price,
                            "color": {
                                "name": orderData.color_name,
                                "code": orderData.color_code
                            },
                            "size": orderData.size,
                            "qty": orderData.count
                        }
                    ]
                }
            }   
            fetch(`http://${HOST}:${PORT}/api/1.0/order/checkout`, {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify(orderRequest)
            })
            .then(r => r.json())
            .then(d => {
                if ("error" in d) {
                    alert("payment failure")
                } else {
                    location.href = "thankyou.html"
                }
            })
            .catch(e => {
                console.log(e)
            })
        
        })
    })

    function setNumberFormGroupToError(selector) {
        $(selector).addClass('has-error')
        $(selector).removeClass('has-success')
    }

    function setNumberFormGroupToSuccess(selector) {
        $(selector).removeClass('has-error')
        $(selector).addClass('has-success')
    }

    function setNumberFormGroupToNormal(selector) {
        $(selector).removeClass('has-error')
        $(selector).removeClass('has-success')
    }

    function forceBlurIos() {
        if (!isIos()) {
            return
        }
        var input = document.createElement('input')
        input.setAttribute('type', 'text')
        // Insert to active element to ensure scroll lands somewhere relevant
        document.activeElement.prepend(input)
        input.focus()
        input.parentNode.removeChild(input)
    }

    function isIos() {
        return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }
</script>
</body>
</html>